<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv=Content-Type content="text/html; charset=utf8">
<title>Bootstrapping Plan 9 on PCs</title>
</meta>
</head>
<body>
<p style="margin-top: 0; margin-bottom: 0.50in"></p>
<p style="margin-top: 0; margin-bottom: 0.21in"></p>

<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 12pt"><b>Bootstrapping Plan 9 on PCs</b></span></p>
<p style="margin-top: 0; margin-bottom: 0.21in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>Geoff&nbsp;Collyer</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"><tt>geoff@plan9.bell-labs.com</tt></span><span style="font-size: 10pt"><i>&#65533;</i></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt">Bell&nbsp;Laboratories</span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt">Murray&nbsp;Hill,&nbsp;New&nbsp;Jersey&nbsp;07974</span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.33in"></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>ABSTRACT</i></span></p>
<p style="margin-top: 0; margin-bottom: 0.19in"></p>
<p style="line-height: 1.2em; margin-left: 1.50in; text-indent: 0.35in; margin-right: 1.50in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">What&rsquo;s interesting, tricky or non-obvious
about bootstrapping Plan 9 on PCs?
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.50in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Introduction
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Plan 9 has new PC bootstraps,
</span><span style="font-size: 10pt"><i>9boot</i></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">,
replacing the decade-old
</span><span style="font-size: 10pt"><i>9pxeload</i></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
programs.
What did we learn while writing them?
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>PC Constraints
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The IBM PC imposes quite a few constraints on bootstrap programs
(programs that load operating system kernels).
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">A PC starts executing in 16-bit &lsquo;real&rsquo; (Intel 8086) mode
and has no boot monitor, as other machines do,
just a primitive yet huge BIOS that will perform a power-on self-test (POST)
and attempt to read boot sectors
from disks or load a modest payload from the network via TFTP.
(Actually some new machines have much more complicated and dangerous
boot loaders called (U)EFI, but we don&rsquo;t deal with EFI.)
The boot sectors must load further bootstrap programs
that resemble the TFTP payload.
These bootstrap programs can only address the first megabyte of memory
until they get out of real mode,
and even then the upper 384KB of the initial megabyte is reserved
for BIOS and device ROMs.
This limits boot programs to at most 640K,
and less for ones loaded by PXE (network boot) ROMs.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The ceiling on memory available to PXE payloads is unclear.
Various sources give it as 480K (UNDI start; Symantec),
536K (Intel Nuc),
564K (base of stack; PXE spec.),
606K (PXE spec.),
or
624K (PC Engines APU2),
or the start of the EBDA, the extended BIOS data area.
The top of &lsquo;free base memory&rsquo; is a likely ceiling
and is
</span><span style="font-size: 10pt"><tt>*(ushort*)0x413</tt></span><span style="font-size: 10pt">
(sic),
expressed in kilobytes.
The address of the EBDA is
</span><span style="font-size: 10pt"><tt>*(ushort*)0x40e &lt;&lt; 4</tt></span><span style="font-size: 10pt">.
It is often 639K, but has been seen as low as 626K on an Intel Nuc,
and could be even lower.
The PXE ROMs are likely to enforce the payload ceiling,
but we must be careful not to step on the EBDA.
As a result of the payload ceiling not being fixed, it&rsquo;s not obvious
how large a program we can load via PXE.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">BIOS calls (via the
</span><span style="font-size: 10pt"><tt>INT</tt></span><span style="font-size: 10pt">
instruction)
only work in real mode,
so the bootstraps execute BIOS calls to learn the machine&rsquo;s
memory map and power management configuration,
and stash the results in the first megabyte
for later retrieval by the loaded kernel.
Empirically, some BIOSes enable interrupts (with
</span><span style="font-size: 10pt"><tt>STI</tt></span><span style="font-size: 10pt">
instructions)
during BIOS calls,
so the bootstraps disable them again after each call;
failure to do so often results in an interrupt,
perhaps from the clock, resetting the machine.
</span><span style="font-size: 10pt"><i>9loadusb</i></span><span style="font-size: 10pt">
returns briefly to real mode
to read USB devices and has mixed results with that.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Getting into 32-bit protected mode permits addressing the first 4GB of memory,
but first it is necessary to enable the A20 address line (the
</span><span style="font-size: 10pt"><tt>1&lt;&lt;20</tt></span><span style="font-size: 10pt">
bit).
For (extreme) backward compatibility, this bit is normally held to zero
until software requests that it be released, and holding it to zero will cause
references to the second megabyte to be mapped to the first, etc.,
causing bizarre-seeming memory corruption.
The old technique was to ask the keyboard controller to release it,
but some systems now have no keyboard controller (they are servers
or have USB keyboards).
We have found it necessary to keep trying different methods until one
is verified to have succeeded.
The new bootstraps also try an
</span><span style="font-size: 10pt"><tt>INT</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"><tt>15</tt></span><span style="font-size: 10pt">
BIOS call and
manipulation of port
</span><span style="font-size: 10pt"><tt>0x92</tt></span><span style="font-size: 10pt">
(&lsquo;system control&rsquo; on some systems).
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Even in protected mode with A20 enabled, some systems
force a gap in the physical address space between 15MB and 16MB,
which must be avoided.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Plan 9 Requirements
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.21in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">&bull;  The new bootstraps must be able to load 64-bit
</span><span style="font-size: 10pt"><tt>amd64</tt></span><span style="font-size: 10pt">
kernels as well as 32-bit
</span><span style="font-size: 10pt"><tt>386</tt></span><span style="font-size: 10pt">
ones.
In addition to Plan 9 boot image format,
the new bootstraps understand ELF and ELF64 formats.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.21in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">&bull;  Plan 9 kernels need to be started in 32-bit protected mode and
implicitly assume that A20 is enabled.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.21in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">&bull;  They expect a parsed
</span><span style="font-size: 10pt"><tt>/cfg/pxe/</tt></span><span style="font-size: 10pt"><i>ether</i></span><span style="font-size: 10pt">
or
</span><span style="font-size: 10pt"><tt>plan9.ini</tt></span><span style="font-size: 10pt">
file to be present at physical address
</span><span style="font-size: 10pt"><tt>0x1200</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.21in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">&bull;  They expect that
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
will have added entries to the parsed
</span><span style="font-size: 10pt"><tt>plan9.ini</tt></span><span style="font-size: 10pt">
describing any disk partitions found.
</span><span style="font-size: 10pt"><b>NB:</b></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"><i>9boot</i></span><span style="font-size: 10pt">
does not do this and so kernels loaded by it
that use disk partitions before
</span><span style="font-size: 10pt"><i>cpurc</i></span><span style="font-size: 10pt">
or
</span><span style="font-size: 10pt"><i>termrc</i></span><span style="font-size: 10pt">
runs will need to
</span><span style="font-size: 10pt"><i>not</i></span><span style="font-size: 10pt">
have
</span><span style="font-size: 10pt"><tt>readparts=0</tt></span><span style="font-size: 10pt">
in
</span><span style="font-size: 10pt"><tt>plan9.ini</tt></span><span style="font-size: 10pt">,
if any.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.21in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">&bull;  They expect the E820 memory map and
automatic power management information obtained from the
BIOS to be present in the first megabyte.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.21in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">&bull;  Our
</span><span style="font-size: 10pt"><tt>9k</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"><tt>amd64</tt></span><span style="font-size: 10pt">
kernels also expect a Gnu
</span><span style="font-size: 10pt"><i>multiboot</i></span><span style="font-size: 10pt">
header containing any arguments and a memory map.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Non-Requirements
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.21in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">&bull;  The bootstraps should ignore secondary processors, leaving them in reset.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.21in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">&bull;  The bootstraps need not do anything with floating point.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Techniques and Tricks
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Our new bootstraps are stripped-down Plan 9 PC kernels
without system calls and user-mode processes.
They share the vast majority of their code with the ordinary PC kernels.
750 lines of C are changed files from the PC kernel,
another 7,800 lines are new or carried forward (possibly modified)
from the old
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">.
In particular, they use the ordinary PC kernel&rsquo;s device drivers,
unmodified.
</span><span style="font-size: 10pt"><i>9boot</i></span><span style="font-size: 10pt">
loads kernels via TTFTP&#65533;
</span></p><p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.50in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">(or can be configured to use PXE);
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
loads kernels from disk.
This is more specialised than the old all-in-one
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">,
in order to fit into low memory.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">From protected mode,
the bootstraps initially enable paging for their own use.
Before jumping to the loaded kernel, they turn paging off, reverting
to plain protected mode, providing a known initial CPU state
for the kernels.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Self-decompression of the bootstraps
helps to relieve the ~600KB payload limits
on PXE-loaded bootstraps and PBS-loaded ones.
Our version of
Russ Cox&rsquo;s decompressing header* code is about 12K all told,
</span></p><p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.50in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">including BIOS calls to get APM and E820 memory map info.
It now also converts that E820 map to a Multiboot map,
for the benefit of our
</span><span style="font-size: 10pt"><i>amd64</i></span><span style="font-size: 10pt">
kernels loaded directly by PXE.
We initially compressed only
</span><span style="font-size: 10pt"><i>9boot</i></span><span style="font-size: 10pt">
(because it was approaching 600K with a full complement of Ethernet drivers)
but now compress all the bootstraps.
Stripping the kernel and switching from
</span><span style="font-size: 10pt"><i>gzip</i></span><span style="font-size: 10pt">
to
</span><span style="font-size: 10pt"><i>lzip</i></span><span style="font-size: 10pt">
compression gives a typical size-reduction ratio of 4:1,
which makes feasible direct loading (e.g., by PXE and bypassing
</span><span style="font-size: 10pt"><i>9boot</i></span><span style="font-size: 10pt">
or
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">)
of compressed kernels that fit in free base memory,
which includes generic terminal and CPU kernels.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The bootstraps also will decompress
</span><span style="font-size: 10pt"><i>lzip</i></span><span style="font-size: 10pt">-ped
kernels loaded from disk,
mainly for CD or other emulated-floppy booting,
where there are limits on kernel size.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Figure 1 shows the memory map in effect while the bootstraps run.
</span><span style="font-size: 10pt"></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Our USB stack (at least 3 HCI drivers plus user-mode drivers,
implying system calls and user-mode support) is too big
to fit in the first 640KB (or less),
so the bootstraps try to get BIOSes to read from USB devices
and some of them do.
Real mode BIOS calls are an ugly solution,
but USB is an ugly problem.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">We strongly prefer network booting; disk booting is a poor second.
Network booting minimises the number of copies of kernels that must
be updated and ensures that machines boot the latest kernels.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Other differences from the old bootstraps
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The old
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
was a single process derived (but separately evolved) from
an old PC kernel, so it needed modified device drivers
(primarily for ethernet and disk controllers), which was an ongoing
maintenance nuisance, and not all ethernet controllers had bootstrap drivers.
The new bootstraps are just specialised Plan 9 kernels that
are loaded compressed into the first 640KB of RAM,
so they use unmodified Plan 9 drivers.
There isn&rsquo;t enough room below 640K to include useful support
for user mode and system calls, but the new bootstraps do implement
kernel processes.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The old
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
was capable of loading from disks, floppies, USB disks or ethernet (via PXE).
Again due to space limitations,
we&rsquo;ve had to focus the new bootstraps more sharply.
</span><span style="font-size: 10pt"><i>9boot</i></span><span style="font-size: 10pt">
loads via TTFTP (or PXE) and nothing else, which is our usual mode of operation.
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
loads from non-USB disks but not floppies,
which ought to be obsolete by now.
If you must boot from floppy and are doing so now,
and your BIOS won&rsquo;t boot from USB,
do this to arrange to boot from USB disk instead:
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.50in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><tt>a:&nbsp;&amp;&amp;&nbsp;cp&nbsp;/386/9loadusb&nbsp;/n/a:/9load</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.02in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>9loadusb</i></span><span style="font-size: 10pt">
loads from USB disks only (using BIOS INT 13 calls).
BIOSes seem to be easily confused by intermixing direct I/O and BIOS calls,
thus we keep
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><i>9loadusb</i></span><span style="font-size: 10pt">
distinct.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The new
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
will look on all available disks for FAT file systems.
If no bootfile is specified in a
</span><span style="font-size: 10pt"><tt>plan9.ini</tt></span><span style="font-size: 10pt">,
it will examine each file
system to see if it contains a single Plan 9 kernel
(</span><span style="font-size: 10pt"><tt>9pc*</tt></span><span style="font-size: 10pt">
or
</span><span style="font-size: 10pt"><tt>9k10*</tt></span><span style="font-size: 10pt">),
and if so, will boot it.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>9boot</i></span><span style="font-size: 10pt">
contains no disk drivers, so it can&rsquo;t read partition
tables and populate
</span><span style="font-size: 10pt"><tt>#ec/sd??part</tt></span><span style="font-size: 10pt">
for the kernel&rsquo;s benefit, so if you need to access a disk partition
early in the kernel&rsquo;s execution
(e.g., you have an nvram partition),
you&rsquo;ll want to ensure that
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.50in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><tt>readparts=0</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.02in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">is
</span><span style="font-size: 10pt"><i>not</i></span><span style="font-size: 10pt">
present in the
</span><span style="font-size: 10pt"><tt>/cfg/pxe</tt></span><span style="font-size: 10pt">
file for any such machines.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The new bootstraps run on more machines than the old ones did.
We discovered new ways to enable the A20 address line and try them all
until success.
This may fix various odd memory corruption problems
seen in the past.
We also discovered that BIOS calls may enable
interrupts, so we disable them again immediately upon return.
This
may prevent mysterious resets seen with the old bootstraps.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>CD booting changes
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>Pbsraw</i></span><span style="font-size: 10pt">
can be up to 2KB, so we can print and provide better service;
it uses things written by
</span><span style="font-size: 10pt"><i>mk9660</i></span><span style="font-size: 10pt">.
It reads a contiguous file and is 468 bytes long
(we dropped the
</span><span style="font-size: 10pt"><tt>9fat</tt></span><span style="font-size: 10pt">
support),
so it could be used to load from any raw partition supporting LBA access.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">There are corresponding changes to
</span><span style="font-size: 10pt"><i>mk9660</i></span><span style="font-size: 10pt">
to annotate the PBS.
A new parameter,
</span><span style="font-size: 10pt"><tt>-x</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"><i>loader</i></span><span style="font-size: 10pt">,
names a loader,
which must be in the root directory.
In conjunction with
</span><span style="font-size: 10pt"><tt>-B</tt></span><span style="font-size: 10pt">,
it can be used to boot directly from the CD.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
was changed to read a
</span><span style="font-size: 10pt"><tt>9fat</tt></span><span style="font-size: 10pt">
image file in the root directory of a CD image,
which must be called
</span><span style="font-size: 10pt"><tt>bootdisk.img</tt></span><span style="font-size: 10pt">
and can be of any size but must be contiguous.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Future Horrors/Directions
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">We haven&rsquo;t dealt at all with (U)EFI, &lsquo;secure boot&rsquo;, GPTs nor GUIDs.
Current real-mode operations,
such as obtaining the physical memory map
and power management information, and
resetting VGA and floppy controllers,
would have to be done with UEFI calls in protected mode
rather than real-mode BIOS calls.
We
</span><span style="font-size: 10pt"><i>can</i></span><span style="font-size: 10pt">
use bare Plan 9 partition tables instead of MBRs or GPTs
to address disks larger than 2 TB.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Lessons Learned
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">A disabled A20 line can masquerade as all sorts of baffling problems.
It is well worth ensuring that it is truly enabled.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Real-mode code is hard to get right,
even when you know that it is hard to get right.
Conditional jumps only take byte displacements, so for targets
farther away, we must use an unconditional long jump.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Virtual-machine hypervisors can be good test-beds and provide
better crash diagnostics than the
blank screen you get on real hardware,
but they can also mislead
(e.g.,
</span><span style="font-size: 10pt"><tt>amd64</tt></span><span style="font-size: 10pt">
kernels on Virtualbox,
Vmware 7 on Ubuntu 12.04).
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">All of these bootstrap programs and the BIOS (and POST) can be avoided,
once Plan 9 is running,
by using
</span><span style="font-size: 10pt"><tt>/dev/reboot</tt></span><span style="font-size: 10pt">
as packaged up in
</span><span style="font-size: 10pt"><i>fshalt</i></span><span style="font-size: 10pt">(8),
which is much faster.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Compressed kernels that fit in free base memory
(</span><span style="font-size: 10pt"><i>9pclz</i></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><i>9pccpulz</i></span><span style="font-size: 10pt">)
can now be directly loaded via PXE and bypass these bootstraps.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Acknowledgements
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Jim McKie
wrote previous PC bootstraps, notably the original
</span><span style="font-size: 10pt"><i>9load</i></span><span style="font-size: 10pt">
and its DOS predecessors,
</span><span style="font-size: 10pt"><i>l.com</i></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><i>b.com</i></span><span style="font-size: 10pt">,
from which much code has been borrowed.
Russ Cox
described the decompressing header used by these bootstraps.
</span></p><p style="margin-top: 0; margin-bottom: 0.50in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><b>Notes</b></span><span style="font-size: 10pt">
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">&#65533; now
</span><span style="font-size: 10pt"><tt>geoff@collyer.net</tt></span><span style="font-size: 10pt">
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

</body>
</html>

